<!DOCTYPE HTML>
<html>
	<head>
		<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <!-- A-Frame + Ar.js --> 
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://unpkg.com/aframe-event-set-component@5/dist/aframe-event-set-component.min.js"></script>
    <script src="https://unpkg.com/aframe-layout-component@5.3.0/dist/aframe-layout-component.min.js"></script>
    <script src="https://unpkg.com/aframe-template-component@3.2.1/dist/aframe-template-component.min.js"></script>
    <script src="https://unpkg.com/aframe-proxy-event-component@2.1.0/dist/aframe-proxy-event-component.min.js"></script>
    <script src="onoff.js"></script>

    <!-- Button link template to be reused. -->
    <script id="link" type="text/html">
      <a-entity class="link"
        geometry="primitive: plane; height: 1; width: 2"
        material="shader: flat; src: ${thumb}"
        event-set__mouseenter="scale: 1.2 1.2 1"
        event-set__mouseleave="scale: 1 1 1"
        event-set__click="_target: #page; _delay: 300"
        proxy-event="event: click; to: #page"
        sound="on: click; src: #click-sound"></a-entity>
    </script>  

    <!-- Register an aframe component that allows reacting to marker events -->
    <script>
      let markerWPos = 0, cameraWPos = 0;
      let camera3D;

      window.addEventListener('camera-init', (data) => {
          console.log('camera-init', data);
      })

      window.addEventListener('camera-error', (error) => {
          console.log('camera-error', error);
      })

      AFRAME.registerComponent('registerevents', {
        init: function () {
          const sceneEl = document.querySelector('a-scene');
          camera3D = document.querySelector('#camera').object3D;
          var marker = this.el;
          var Boxes = [];
          
          marker.addEventListener('markerFound', function() {
            var markerId = marker.id;
            console.log('markerFound', markerId);

            // Validate Box instances
            if (!Boxes.includes(markerId)) {

              // Get Marker World Position through marker3D
              var tBoxPos;
              var marker3D = marker.object3D;
              markerWPos = new THREE.Vector3();
              marker3D.getWorldPosition(markerWPos);
              markerWPos.round();
              console.log("Marker W Pos X " + markerWPos.x);
              console.log("Marker W Pos Y " + markerWPos.y);
              console.log("Marker W Pos Z " + markerWPos.z);

              // Create and display text box + text
              var tBox = document.createElement('a-image');
              sceneEl.appendChild(tBox);
              tBox.id = 'TestImage';
              tBox.setAttribute('src', '#text_box');
              tBox.setAttribute('width', 5.3);
              tBox.setAttribute('height', 3);
              var tBoxObject3D = document.querySelector('#TestImage').object3D;
              tBoxObject3D.position.set(markerWPos.x, markerWPos.y, markerWPos.z);
              console.log(tBoxObject3D);

              var displayT = document.createElement('a-text');
              tBox.appendChild(displayT);
              displayT.id = "DisplayText";
              displayT.setAttribute('value', markerWPos.x);
              displayT.setAttribute('color','blue');
              var tDispObject3D = document.querySelector('#DisplayText').object3D;
              tDispObject3D.position.set(-0.5, 0.5, 2);
              // console.log(tDispObject3D);

              // Read current cam position
              // cameraWPos = new THREE.Vector3();
              // camera3D.getWorldPosition(cameraWPos);
              // cameraWPos.round();
              
              // Add marker ID to Box instances
              Boxes.push(markerId);

            } else {
              console.log("instance not duplicated");
              // Get camera-marker position differences
              // var newCameraWPos = new THREE.Vector3();
              // camera3D.getWorldPosition(newCameraWPos);
              // newCameraWPos.round();
              // console.log("Cam-Marker Dist " + cameraWPos.distanceTo(markerWPos));
              // console.log("New Cam-Marker Dist " + newCameraWPos.distanceTo(markerWPos));
              // if (cameraWPos.distanceTo(markerWPos) != newCameraWPos.distanceTo(markerWPos)) {
              //   console.log("Cam-Marker Dist " + cameraWPos.distanceTo(markerWPos));
              //   console.log("New Cam-Marker Dist " + newCameraWPos.distanceTo(markerWPos));
              //   // console.log("Cam-Marker X Diff " + (newCameraWPos.x - markerWPos.x));
              //   // console.log("Cam-Marker Y Diff " + (newCameraWPos.y - markerWPos.y));
              //   // console.log("Cam-Marker Z Diff " + (newCameraWPos.z - markerWPos.z));

              // }



            }

                          
          });

          marker.addEventListener('markerLost', function() {
            var markerId = marker.id;
            console.log('markerLost', markerId);
            
          });


        },

        tick: (function () {
          var cameraWPos = new THREE.Vector3();

          return function () {
            camera3D.getWorldPosition(cameraWPos);
            console.log("Cam Pos x" + cameraWPos.x);
            console.log("Cam Pos y" + cameraWPos.y);
            console.log("Cam Pos z" + cameraWPos.z);
          };
        })()

 
      });

      // AFRAME.registerComponent('rotation-reader', {
      //   tick: function () {
      //     // `this.el` is the element.
      //     // `object3D` is the three.js object.

      //     // `rotation` is a three.js Euler using radians. `quaternion` also available.
      //     console.log(this.el.object3D.rotation);

      //     // `position` is a three.js Vector3.
      //     console.log(this.el.object3D.position);
      //   }
      // });
    </script>

	</head>

	<body style="margin: 0px; overflow: hidden;">

		<!-- Use AR.js in AFRAME with MatrixCodeType markers -->
		<a-scene xr-mode-ui="enabled: false" embedded arjs="sourceType: webcam; debugUIEnabled: false;  detectionMode: mono_and_matrix; matrixCodeType: 3x3;">
      <a-assets>
        <img id="text_box" src="src/media/Text_Box.jpg">
        <img id="link_button" src="src/media/Button.jpg">
        <audio id="click-sound" crossorigin="anonymous" src="https://cdn.aframe.io/360-image-gallery-boilerplate/audio/click.ogg"></audio>
        <a-asset-item id="animated-asset" src="https://raw.githubusercontent.com/nicolocarpignoli/nicolocarpignoli.github.io/master/ar-click-events/models/CesiumMan.gltf"></a-asset-item>
      </a-assets>
        
      <!-- Define markers -->
      <a-marker emitevents="true" cursor="rayOrigin: mouse" id="marker2" type="pattern" url="https://raw.githack.com/valfishchang/valfishchang.github.io/main/src/marker/pattern-AMP172-001.patt"
      emitevents="true" smooth="true" smooth-count="10" smooth-tolerance="0.5" smooth-threshold="2" registerevents>


      </a-marker>



      <!-- Debug -->
      <!-- <a-box color="tomato" depth="2" height="4" width="0.5"></a-box> -->

      <!-- Camera & Cursor -->
      <a-entity id="camera" camera look-controls>
        <!-- <a-box color="tomato" depth="2" height="4" width="0.5" position="-1 0 -5"></a-box> -->
        <a-cursor
          id="cursor"
          animation__click="property: scale; startEvents: click; from: 0.1 0.1 0.1; to: 1 1 1; dur: 150"
          animation__fusing="property: fusing; startEvents: fusing; from: 1 1 1; to: 0.1 0.1 0.1; dur: 1500"
          event-set__mouseenter="_event: mouseenter; color: springgreen"
          event-set__mouseleave="_event: mouseleave; color: black"
          raycaster="objects: .link">
        </a-cursor>

         
      </a-entity>
		</a-scene>

	</body>
</html>